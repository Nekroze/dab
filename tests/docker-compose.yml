version: '3.2'

services:

  dab:
    build:
      context: ../
      dockerfile: Dockerfile
    image: nekroze/dab:latest

  tests:
    image: 'nekroze/containaruba:alpine'
    environment:
      DAB_AUTOUPDATE: 'no'
      DAB_WRAPPER_PATH: "${PWD}/dab"
    volumes:
      - ./features:/usr/src/app/features
      - ../dab:/usr/bin/dab
    command:
      - '--order=random'
      - '--retry=2'

  build:
    image: docker/compose:1.22.0
    command: build --force-rm --pull dab
    working_dir: /opt/dab/tests
    volumes:
      - ../:/opt/dab:ro

  docs:
    build: .
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ./features/:/usr/src/app/features
      - ./docs/templates/:/usr/src/app/templates
      - ./docs/:/usr/src/app/output

volumes:
  data:
  sock:
