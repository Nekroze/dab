version: '3.5'

services:

  influxdb:
    image: "influxdb:${DAB_SERVICES_INFLUXDB_TAG:-alpine}"
    restart: on-failure
    labels:
      description: 'Time series database from the TICK stack'
      com.centurylinklabs.watchtower.enable: 'true'
    volumes:
      - influxdb:/var/lib/influxdb
    healthcheck:
      test: 'wget --spider http://localhost:8086/ping || exit 1'
      interval: 30s
      timeout: 10s
      retries: 3
    tmpfs:
      - /tmp

  telegraf:
    build:
      context: .
      dockerfile: Dockerfile.telegraf
      args:
        - "TELEGRAF_TAG=${DAB_SERVICES_TELEGRAF_TAG:-alpine}"
    labels:
      description: 'Metrics collection agent from the TICK stack'
    restart: on-failure
    command: --quiet
    depends_on:
      - influxdb
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/run/utmp:/var/run/utmp:ro
    healthcheck:
      test: 'wget --spider http://localhost:8086/ping || exit 1'
      interval: 30s
      timeout: 10s
      retries: 3
    tmpfs:
      - /tmp

  logspout:
    image: "gliderlabs/logspout:${DAB_SERVICES_LOGSPOUT_TAG:-latest}"
    restart: on-failure
    labels:
      description: 'Log routing for Docker container logs, points to tick'
      com.centurylinklabs.watchtower.enable: 'true'
    volumes:
      - /etc/hostname:/etc/host_hostname:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      syslog://telegraf:6514
    depends_on:
      - telegraf
    environment:
      INACTIVITY_TIMEOUT: 1m
    tmpfs:
      - /tmp

  consul:
    image: "consul:${DAB_SERVICES_CONSUL_TAG:-latest}"
    restart: on-failure
    labels:
      description: 'Services discovery and key value store'
      com.centurylinklabs.watchtower.enable: 'true'
    volumes:
      - consul:/consul/data
    ports:
      - 8500
    environment:
      CONSUL_LOCAL_CONFIG: >
        {
          "datacenter": "${DAB_INSTANCE_NAME:-dab}",
          "skip_leave_on_interrupt": true,
          "addresses": {
            "http": "0.0.0.0",
            "dns": "0.0.0.0"
          }
        }
    command: agent -server -bootstrap -ui
    healthcheck:
      test: 'wget --spider http://localhost:8500/v1/status/leader || exit 1'
      interval: 30s
      timeout: 10s
      retries: 3
    tmpfs:
      - /tmp

  redis:
    image: "redis:${DAB_SERVICES_REDIS_TAG:-latest}"
    labels:
      description: 'In-memory data structure store'
      com.centurylinklabs.watchtower.enable: 'true'
    restart: on-failure
    healthcheck:
      test: 'redis-cli ping'
      interval: 30s
      timeout: 10s
      retries: 3
    ports:
      - '16379:6379'
    tmpfs:
      - /tmp

  vault:
    build:
      context: .
      dockerfile: Dockerfile.vault
      args:
        - "VAULT_TAG=${DAB_SERVICES_VAULT_TAG:-latest}"
    labels:
      description: 'Store, manage, and generate secrets with Hashicorp Vault'
    restart: on-failure
    healthcheck:
      test: 'netstat -tulpn | grep 0.0.0.0:8200'
      interval: 30s
      timeout: 10s
      retries: 3
    environment:
      VAULT_ADDR: 'http://127.0.0.1:8200'
    cap_add:
      - IPC_LOCK
    depends_on:
      - consul
      - telegraf
    tmpfs:
      - /tmp

  postgres:
    image: "postgres:${DAB_SERVICES_POSTGRES_TAG:-alpine}"
    labels:
      description: 'Object-relational database management system'
      com.centurylinklabs.watchtower.enable: 'true'
    restart: on-failure
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres:/var/lib/postgresql/data/pgdata
    tmpfs:
      - /tmp

  elasticsearch:
    image: "docker.elastic.co/elasticsearch/elasticsearch:${DAB_SERVICES_ELASTICSEARCH_TAG:-6.4.2}"
    labels:
      description: 'Object-relational database management system'
    restart: on-failure
    environment:
      discovery.type: 'single-node'
      bootstrap.memory_lock: 'true'
      ES_JAVA_OPTS: '-Xms512m -Xmx512m'
    healthcheck:
      test: 'curl -fsSL "http://localhost:9200/_cat/health?h=status" | grep green'
      interval: 30s
      timeout: 10s
      retries: 3
    tmpfs:
      - /tmp

  zookeeper:
    image: "confluentinc/cp-zookeeper:${DAB_SERVICES_ZOOKEEPER_TAG:-latest}"
    labels:
      description: 'Distributed configuration service'
      com.centurylinklabs.watchtower.enable: 'true'
    restart: on-failure
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_LOG4J_ROOT_LOGLEVEL: WARN
    tmpfs:
      - /tmp

  kafka:
    image: "confluentinc/cp-kafka:${DAB_SERVICES_KAFKA_TAG:-latest}"
    labels:
      description: 'Stream processing platform'
      com.centurylinklabs.watchtower.enable: 'true'
    restart: on-failure
    depends_on:
      - zookeeper
    environment:
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka:9092'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_LOG4J_ROOT_LOGLEVEL: WARN
    tmpfs:
      - /tmp

volumes:
  postgres:
  influxdb:
  grafana:
  consul:
  vault:

networks:
  default:
    external:
      name: services
